# План: Пайплайн подготовки Anki-карточек

## Цель
Создать воспроизводимый пайплайн для генерации французских Anki-карточек на основе Lexique383 с возможностью итеративной доработки.

---

## Ревью плана

### Обнаруженные несоответствия

1. **Формула частотности**
   - В существующем `extract_lexique_selection.py`: `freqlemfilms2 + freqlemlivres` (простая сумма)
   - В плане: `0.6 * freqlemfilms2 + 0.4 * freqlemlivres` (взвешенная)
   - **Решение**: Использовать взвешенную формулу (лучше для устной речи TEF/TCF)

2. **Категория числительных**
   - В плане указано `NUM`, но в Lexique383 это `ADJ:num` (123 записи)
   - **Решение**: Исправить на `ADJ:num`

3. **Порядок генерации карточек**
   - План: сначала редкие категории, потом основные
   - **Проблема**: Для изучения языка логичнее начинать с высокочастотных слов
   - **Решение**: Генерация по убыванию частотности внутри каждой категории, но порядок экспорта — от простого к сложному

4. ~~**Отсутствует этап валидации**~~ (решено встроить в основные скрипты)

5. **Редкие категории требуют детализации**
   - `other.csv` содержит формы одного слова как отдельные леммы (ce/cette/ces/cet)
   - **Проблема**: Это не разные леммы, а формы одной леммы
   - **Решение**: Объединять формы в одну карточку где возможно

### Принятые решения

| # | Вопрос | Решение |
|---|--------|---------|
| 1 | Формула частотности | Взвешенная: `0.6 * freqlemfilms2 + 0.4 * freqlemlivres` |
| 2 | Blacklist формат | `lemme + cgram + reason` (причины: archaic, parse_error) |
| 3 | Azure TTS голос | Все 4 канадских голоса (fr-CA) в равной пропорции |
| 4 | Порог частотности | Подобрать для ~20000 слов в итоговой выборке |
| 5 | Формы (ce/cette/ces/cet) | Группировать → по карточке на каждую форму + в примечаниях другие формы |
| 6 | Омографы разных категорий | Не обрабатывать (son-NOM vs son-ADJ:pos — разные карточки) |
| 7 | Омографы одной категории | По карточке на каждую лемму + указывать омографы в примечаниях |
| 8 | Нерегулярные прилагательные | Аналогично формам: beau/belle → 2 карточки + взаимные ссылки |
| 9 | Фразы, эмоджи, примечания | Заполняются с помощью ИИ (не скриптами) |
| 10 | Порядок: озвучка vs Anki | Сначала озвучить → потом генерировать .apkg |
| 11 | Канадские слова, выражения | Требует отдельного исследования |

---

## Этапы пайплайна

### 1. Парсинг базы данных Lexique
- Входные данные: `Lexique383.tsv`
- Фильтрация: `islem=1` (только леммы)
- Расчёт комбинированной частотности: `0.6 * freqlemfilms2 + 0.4 * freqlemlivres`
- Выходные данные: `categories/*.csv` (NOM, VER, ADJ, ADV и редкие категории)

### 2. Ревью редких категорий ✅
- Ручной просмотр: PRE, CON, ONO, AUX, PRO, DET, ART, ADV и др.
- Выявление устаревших слов, ошибок в данных
- Результат: `data/blacklist.csv` (93 записи)

### 3. Фильтрация числительных (ADJ:num) ✅
- Составные, римские и ошибочные исключены в `data/blacklist.csv` (88 записей ADJ:num)
- Базовые числительные = ADJ_num.csv минус blacklist (35 записей)

### 4.1 Обработка существительных без указания рода ✅
- Скрипт: `scripts/04a_find_nom_without_genre.py`
- Результат: 547 NOM классифицированы (100% done)
- Файлы: `data/nom_without_genre.csv`, `data/gender_homographs.csv`

### 4.2 Проверка профессий m/f ✅
- Скрипт: `scripts/04b_check_professions.py`
- Результат: 875 NOM с обеими формами, 188 профессий без f-формы
- Файлы: `data/professions_check.csv`, `data/m_only_profession_reviewed.csv`
- Дополнение: `additions/professions_f.csv` (141 f-форма для импорта)

### 4.3 Сбор нерегулярных прилагательных ✅
- Скрипт: `scripts/04c_find_irregular_adj.py`
- Критерий: m-форма ≠ f-форма + e (beau/belle, vieux/vieille)
- Результат: `categories/ADJ.csv` содержит колонку `morph_pattern`

### 4.4 Сбор нерегулярных глаголов ✅
- Скрипт: `scripts/04d_find_irregular_verbs.py`
- Критерий: 3e groupe (нестандартные основы)
- Результат: `data/irregular_verbs.csv` (338 глаголов выше порога)

### 5. Ручные дополнения (частично)
- `additions/professions_f.csv` — 141 f-форма профессий ✅
- `additions/canadian_french.csv` — канадские слова (TODO: требует исследования)
- `additions/expressions.csv` — устойчивые выражения (TODO: требует исследования)

### 6. Генерация карточек

#### 6.1 Порядок генерации
1. Редкие категории (PRE, CON, ONO, NUM, ART, DET, PRO)
2. Дополнения (канадские слова, выражения)
3. Основные категории по убыванию частотности:
   - ADV (наречия)
   - ADJ (прилагательные)
   - VER (глаголы)
   - NOM (существительные)

#### 6.2 Правила дублирования лемм
| Тип | Примеры | Количество карточек |
|-----|---------|---------------------|
| Регулярные прилагательные | petit → petite | 1 карточка: `petit, petite` |
| Инвариантные прилагательные | rouge, possible | 1 карточка: `rouge` |
| Нерегулярные прилагательные | beau/belle, vieux/vieille | 2 карточки: отдельно m и f |
| Регулярные существительные | maison, livre | 1 карточка с артиклем |
| Профессии (m/f пары) | acteur/actrice | 2 карточки: отдельно m и f |
| Глаголы | parler, aller | 1 карточка |

#### 6.3 Обязательные примечания
- Прилагательные: `+e au féminin` / `invariable` / для нерегулярных — парная форма
- Существительные: род (m/f)
- Глаголы: группа (1er/2e/3e groupe), нерегулярность
- Омографы одной категории: ссылки на другие значения
- Формы одного слова (ce/cette): ссылки на другие формы

#### 6.4 Поля, заполняемые ИИ (не скриптами)
- **ExampleFrench** — фраза-пример на французском
- **ExampleRussian** — перевод фразы
- **Notes** — примечания (нерегулярность, омографы, формы)
- **Emoji** — эмоджи для визуального запоминания
- **Russian** (Translation) — перевод слова

Скрипты генерируют только структуру карточек (French, WordType, cgram), остальное заполняется через ИИ.

#### 6.5 Правила для канадского французского (NEW)
- Если слово **не используется в Канаде** или используется иначе:
  - Указать в Notes: `⚠️ В Канаде говорят: {канадский вариант}`
  - Пример: `fin de semaine` вместо `week-end`
- Приоритет квебекского варианта при выборе примеров

#### 6.6 Тематика примеров (NEW)
По возможности использовать в ExampleFrench:
- **Юмор** — запоминается лучше
- **Канадская культура** — кленовый сироп, хоккей, зима, poutine
- **Тематика иммиграции** — документы, интеграция, работа, жильё
- **Повседневная жизнь в Квебеке** — магазины, транспорт, погода

### 7. Целевой объём
- **Фаза 1**: 3000 лемм — реалистичный набор на год изучения
- **Фаза 2**: 5000 лемм — уровень B2-C1
- Приоритет: высокочастотные слова для TEF/TCF

### 8. Озвучивание (ПЕРЕД генерацией Anki)
- Технология: Azure TTS (Cognitive Services Speech)
- Что озвучивать:
  - Французское слово
  - Французская фраза-пример
- Требования:
  - Генерация аудио вне Anki (переносимость)
  - Формат: MP3, 128 kbps
  - Именование: `{lemme}.mp3`, `{lemme}_example.mp3`
- **Голоса fr-CA** (все 4 в равной пропорции):
  - fr-CA-SylvieNeural (женский)
  - fr-CA-JeanNeural (мужской)
  - fr-CA-AntoineNeural (мужской)
  - fr-CA-ThierryNeural (мужской)
- **Технические детали**:
  - Batch обработка (3000+ файлов) — нужен rate limiting
  - Кэширование уже сгенерированных файлов
  - Обработка ошибок и повторные попытки
  - Распределение голосов: round-robin или случайное

### 9. Генерация .apkg (ПОСЛЕ озвучивания)
- Входные данные: CSV с карточками + аудиофайлы
- Упаковка аудио в media/ директорию пакета
- Ссылки на аудио: `[sound:{lemme}.mp3]`

### 10. Карточки спряжений (уже готово)
- `French_200_Verbs_Conjugation.csv`
- Отдельный note type: French Conjugation v3 Cloze

---

## Структура файлов

```
sirop-de-mots/
├── Lexique383.tsv              # Исходная база (gitignore)
├── data/
│   ├── blacklist.csv           # Слова для исключения (lemme, cgram, reason)
│   ├── nom_without_genre.csv   # NOM без рода для классификации (генерируется)
│   ├── gender_homographs.csv   # Омографы разных родов (вручную)
│   ├── professions_check.csv   # Проверка m/f профессий (генерируется)
│   ├── irregular_adjectives.csv # Нерегулярные прилагательные (генерируется)
│   └── irregular_verbs.csv     # Нерегулярные глаголы (генерируется)
├── categories/                 # Отфильтрованные категории (gitignore)
│   ├── NOM.csv
│   ├── VER.csv
│   ├── ADJ.csv
│   ├── ADV.csv
│   ├── ADJ_num.csv
│   ├── ONO.csv
│   └── other.csv
├── additions/                  # Ручные дополнения
│   ├── canadian_french.csv     # Требует исследования источников
│   └── expressions.csv         # Требует исследования источников
├── output/                     # Результаты генерации (gitignore)
│   ├── cards_skeleton.csv      # Структура карточек (French, WordType)
│   ├── cards_for_ai.csv        # Для заполнения ИИ
│   ├── cards_complete.csv      # После заполнения ИИ
│   ├── French_Vocabulary_Import.csv
│   ├── French_Conjugation_Import.csv
│   └── audio/
│       ├── words/              # {lemme}.mp3
│       └── examples/           # {lemme}_example.mp3
└── scripts/
    ├── 01_extract_categories.py       # ✅ Парсинг Lexique → categories/
    ├── 04a_find_nom_without_genre.py  # ✅ NOM без рода
    ├── 04b_check_professions.py       # ✅ Профессии m/f
    ├── 04c_find_irregular_adj.py      # ✅ Нерегулярные прилагательные
    ├── 04d_find_irregular_verbs.py    # ✅ Нерегулярные глаголы (3e groupe)
    ├── 05_generate_cards.py           # TODO: blacklist + additions + skeleton
    ├── 08_generate_audio.py           # TODO: Azure TTS
    ├── 09_build_apkg.py               # TODO: Сборка .apkg
    ├── config.py                      # ✅ Настройки (FREQ_MIN_THRESHOLD и др.)
    └── run_pipeline.py                # TODO: Запуск всего пайплайна
```

---

## Открытые вопросы (оставшиеся)

1. **Канадские слова** — какой источник использовать? (требует исследования)
2. **Выражения** — какой объём и какие источники? (требует исследования)
3. ~~**Точный порог частотности**~~ ✅ Определён: `FREQ_MIN_THRESHOLD = 0.67` (~20000 слов)

---

## Критерии готовности

- [ ] Пайплайн запускается одной командой (`python scripts/run_pipeline.py`)
- [ ] Результаты воспроизводимы (одинаковый вход → одинаковый выход)
- [x] Blacklist легко редактировать (CSV с причиной исключения) ✅
- [x] Дополнения легко добавлять (единый формат CSV) ✅
- [ ] Логи показывают статистику на каждом этапе
- [ ] Карточки проходят валидацию перед экспортом
- [ ] Аудио кэшируется (не перегенерируется повторно)

---

## Рекомендации по реализации

### Приоритет этапов
1. ~~**Фаза 1** (Инфраструктура): Структура директорий, config.py~~ ✅
2. ~~**Фаза 2** (Анализ данных): Скрипты 04a/04b/04c/04d → отчёты для ревью~~ ✅
3. ~~**Фаза 3** (Blacklist): Ручной ревью редких категорий → blacklist.csv~~ ✅
4. **Фаза 4** (Skeleton): `05_generate_cards.py` → cards_skeleton.csv ← **ТЕКУЩАЯ**
5. **Фаза 5** (ИИ): Заполнение переводов, примеров, эмоджи через Claude
6. **Фаза 6** (Озвучка): Azure TTS → audio/
7. **Фаза 7** (Финал): Сборка .apkg

### Форматы файлов

**blacklist.csv:**
```csv
lemme,cgram,reason
vingt-et-un,ADJ:num,composite_numeral
archaïsme,NOM,archaic
librairie,NOM,parse_error
```

**nom_without_genre.csv** (генерируется скриптом):
```csv
lemme,freqlem,nbhomogr,type,review_notes
main,791.52,1,f_only,
mort,457.11,3,homograph,
enfant,731.63,1,common_gender,
```

**gender_homographs.csv** (ведётся вручную):
```csv
lemme,genre,meaning_ru,meaning_fr,frequency_note
livre,m,книга,livre (ouvrage),high
livre,f,фунт (вес/валюта),livre (poids/monnaie),medium
tour,m,"обход, ход, оборот",tour (mouvement),high
tour,f,башня,tour (bâtiment),high
```

**cards_skeleton.csv** (генерируется скриптом):
```csv
French,WordType,cgram,freqlem,related_forms
petit,adj,ADJ,1234.5,petite
belle,adj,ADJ,987.2,beau (m)
```

**cards_for_ai.csv** (для заполнения ИИ):
```csv
French,WordType,Russian,ExampleFrench,ExampleRussian,Notes,Emoji
petit,adj,,,,,,
```

### Workflow заполнения через ИИ
1. Скрипт генерирует `cards_skeleton.csv` со структурой
2. Конвертируем в `cards_for_ai.csv` (добавляем пустые поля)
3. Batch-отправка в Claude (по 50-100 карточек)
4. Ручной ревью результатов
5. Сохранение в `cards_complete.csv`

### Следующий шаг
1. ~~Создать структуру директорий (`data/`, `additions/`, `output/`, `scripts/`)~~ ✅
2. ~~Написать `scripts/config.py` с настройками~~ ✅
3. ~~Написать `scripts/04a_find_nom_without_genre.py`~~ ✅
4. ~~Определить порог частотности для ~20000 слов~~ ✅ (FREQ_MIN_THRESHOLD = 0.67)
5. ~~Провести ручную классификацию `nom_without_genre.csv`~~ ✅ (547 слов)
6. ~~Написать остальные скрипты анализа (04b, 04c, 04d)~~ ✅
7. ~~Создать blacklist.csv~~ ✅
8. **Следующий**: Написать `05_generate_cards.py` (объединяет фильтрацию + additions + skeleton)
9. Заполнить карточки через ИИ (переводы, примеры, эмоджи)
10. Написать `08_generate_audio.py` (Azure TTS)
11. Написать `09_build_apkg.py` (сборка .apkg)

---

## Омографы разных родов

### Проблема

В Lexique383 некоторые существительные (NOM) имеют `genre=NaN`. Это происходит по разным причинам:

1. **Истинные омографы** — разные роды означают разные значения
2. **Общий род** — слово может быть m или f с одним значением
3. **Ошибки данных** — род известен, но не указан в базе

### Типы омографов

#### Кросс-категориальные омографы
Одно написание в разных грамматических категориях:
- `bon`: ADJ (хороший), NOM (талон), ADV (ладно), ONO (ну!)
- `tout`: ADJ, ADV, NOM, PRO:ind

**Решение**: Не требуют специальной обработки. Каждая категория получает свою карточку.

#### Омографы разных родов (внутри NOM)
Одно написание, разные роды = разные значения:
- `livre`: m = книга, f = фунт
- `tour`: m = обход/оборот, f = башня
- `poste`: m = пост/должность, f = почта
- `mode`: m = способ, f = мода
- `mort`: m = мертвец, f = смерть

**Решение**: Создавать 2 карточки (для m и f), с указанием другой формы в Notes.

### Ограничения Lexique383

База данных НЕ различает:
- Разные значения внутри одной категории (например, "avocat" = адвокат или авокадо)
- Омографы разных родов хранятся как одна запись с `genre=NaN`

### Классификация NOM без рода

Файл `nom_without_genre.csv` содержит все NOM с `genre=NaN` выше порога частотности.

| type | Описание | Пример | Действие |
|------|----------|--------|----------|
| `homograph` | Разные роды = разные значения | livre, tour, mort | 2 карточки |
| `common_gender` | Один смысл, любой род | enfant, chef, artiste | 1 карточка, WordType=m/f |
| `f_only` | Только f, ошибка Lexique | maison, voiture, chance | 1 карточка, WordType=f |
| `m_only` | Только m, ошибка Lexique | gens, cours, geste | 1 карточка, WordType=m |

### Workflow

```
Lexique383.tsv
      │
      ▼
04a_find_nom_without_genre.py
      │
      ▼
nom_without_genre.csv (547 слов выше порога)
      │
      │ ← ручная классификация (колонка type)
      │
      ▼
gender_homographs.csv (только type=homograph, с деталями m/f)
      │
      ▼
При генерации карточек:
  - Если lemme в gender_homographs → 2 карточки
  - Если type=common_gender → 1 карточка, WordType=m/f
  - Если type=f_only/m_only → 1 карточка с правильным родом
```

### Статистика (текущая)

- NOM без рода выше порога: **547** ✅ (100% классифицировано)
- Омографы (homograph): **30** → `data/gender_homographs.csv`
- Профессии с m/f парами: **875**
- Профессии с недостающими f-формами: **141** → `additions/professions_f.csv`
- Нерегулярные глаголы (3e groupe): **338** → `data/irregular_verbs.csv`

### Известные омографы разных родов

| lemme | m | f | freqlem |
|-------|---|---|---------|
| mort | мертвец | смерть | 457.1 |
| fin | знаток | конец | 253.8 |
| tour | обход, оборот | башня | 239.8 |
| livre | книга | фунт | 233.5 |
| aide | помощник | помощь | 127.6 |
| ombre | хариус (рыба) | тень | 120.8 |
| garde | охранник | охрана | 107.5 |
| poste | пост, должность | почта | 86.0 |
| mémoire | меморандум | память | 80.9 |
| page | паж | страница | 69.9 |
| couple | пара людей | пара (физ.) | 55.4 |
| somme | сон, дремота | сумма | 52.9 |
| politique | политик | политика | 51.2 |
| vague | неясность | волна | 42.4 |
| mode | способ, режим | мода | 39.7 |

Полный список в `data/gender_homographs.csv`.
