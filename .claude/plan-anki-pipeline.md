# План: Пайплайн подготовки Anki-карточек

## Цель
Создать воспроизводимый пайплайн для генерации французских Anki-карточек на основе Lexique383 с возможностью итеративной доработки.

---

## Ревью плана

### Обнаруженные несоответствия

1. **Формула частотности**
   - В существующем `extract_lexique_selection.py`: `freqlemfilms2 + freqlemlivres` (простая сумма)
   - В плане: `0.6 * freqlemfilms2 + 0.4 * freqlemlivres` (взвешенная)
   - **Решение**: Использовать взвешенную формулу (лучше для устной речи TEF/TCF)

2. **Категория числительных**
   - В плане указано `NUM`, но в Lexique383 это `ADJ:num` (123 записи)
   - **Решение**: Исправить на `ADJ:num`

3. **Порядок генерации карточек**
   - План: сначала редкие категории, потом основные
   - **Проблема**: Для изучения языка логичнее начинать с высокочастотных слов
   - **Решение**: Генерация по убыванию частотности внутри каждой категории, но порядок экспорта — от простого к сложному

4. **Отсутствует этап валидации**
   - Нет проверки данных перед генерацией карточек
   - **Решение**: Добавить `00_validate_input.py` и `06_validate_output.py`

5. **Редкие категории требуют детализации**
   - `other.csv` содержит формы одного слова как отдельные леммы (ce/cette/ces/cet)
   - **Проблема**: Это не разные леммы, а формы одной леммы
   - **Решение**: Объединять формы в одну карточку где возможно

### Принятые решения

| # | Вопрос | Решение |
|---|--------|---------|
| 1 | Формула частотности | Взвешенная: `0.6 * freqlemfilms2 + 0.4 * freqlemlivres` |
| 2 | Blacklist формат | `lemme + cgram + reason` (причины: archaic, parse_error) |
| 3 | Azure TTS голос | Все 4 канадских голоса (fr-CA) в равной пропорции |
| 4 | Порог частотности | Подобрать для ~20000 слов в итоговой выборке |
| 5 | Формы (ce/cette/ces/cet) | Группировать → по карточке на каждую форму + в примечаниях другие формы |
| 6 | Омографы разных категорий | Не обрабатывать (son-NOM vs son-ADJ:pos — разные карточки) |
| 7 | Омографы одной категории | По карточке на каждую лемму + указывать омографы в примечаниях |
| 8 | Нерегулярные прилагательные | Аналогично формам: beau/belle → 2 карточки + взаимные ссылки |
| 9 | Фразы, эмоджи, примечания | Заполняются с помощью ИИ (не скриптами) |
| 10 | Порядок: озвучка vs Anki | Сначала озвучить → потом генерировать .apkg |
| 11 | Канадские слова, выражения | Требует отдельного исследования |

---

## Этапы пайплайна

### 0. Валидация входных данных (NEW)
- Проверка наличия `Lexique383.tsv`
- Проверка структуры колонок
- Базовая статистика для логов

### 1. Парсинг базы данных Lexique
- Входные данные: `Lexique383.tsv`
- Фильтрация: `islem=1` (только леммы)
- Расчёт комбинированной частотности: `0.6 * freqlemfilms2 + 0.4 * freqlemlivres`
- Выходные данные: `categories/*.csv` (NOM, VER, ADJ, ADV и редкие категории)

### 2. Ревью редких категорий
- Ручной просмотр: PRE, CON, ONO, AUX, PRO, DET, ART, ADV и др.
- Выявление:
  - Устаревших слов (архаизмы)
  - Неиспользуемых слов
  - Ошибок в данных
- Выход: `blacklist.csv` — список слов для исключения

### 3. Фильтрация числительных (ADJ:num)
- Оставить только базовые: un, deux, trois... vingt, trente... cent, mille
- Исключить составные: vingt-et-un, quatre-vingt-dix-sept и т.д.
- Выход: обновлённый `categories/ADJ_num.csv`
- **Примечание**: В Lexique это категория `ADJ:num`, не `NUM`

### 4. Повторный парсинг с фильтрацией
- Применить `blacklist.csv` ко всем категориям
- Скрипт должен быть идемпотентным (можно запускать многократно)

### 4.1 Анализ омографов (NEW)
- Скрипт поиска омографов внутри одной категории
- Вывод: список пар/групп омографов для ручной проверки
- Пример: `son` (звук) vs `son` (отруби) — оба NOM
- Результат: `data/homographs_report.csv`

### 4.2 Проверка профессий m/f (NEW)
- Скрипт проверки наличия обеих форм для профессий
- Вход: список профессий (NOM с признаком "человек")
- Вывод: отчёт о недостающих формах
- Результат: `data/professions_check.csv`

### 4.3 Сбор нерегулярных прилагательных (NEW)
- Скрипт извлечения ~200 нерегулярных прилагательных
- Критерий: m-форма ≠ f-форма + e (beau/belle, vieux/vieille)
- Результат: `data/irregular_adjectives.csv`

### 4.4 Сбор нерегулярных глаголов (NEW)
- Скрипт извлечения нерегулярных глаголов (3e groupe)
- Критерии: нестандартные основы, особые формы спряжения
- Примеры: aller, être, avoir, faire, pouvoir, vouloir, savoir, venir, etc.
- Результат: `data/irregular_verbs.csv`

### 5. Ручные дополнения
- `additions/canadian_french.csv` — канадские слова и выражения
- `additions/expressions.csv` — устойчивые выражения (loc, expr)
- Формат: такой же как основные категории + поле `source`

### 6. Генерация карточек

#### 6.1 Порядок генерации
1. Редкие категории (PRE, CON, ONO, NUM, ART, DET, PRO)
2. Дополнения (канадские слова, выражения)
3. Основные категории по убыванию частотности:
   - ADV (наречия)
   - ADJ (прилагательные)
   - VER (глаголы)
   - NOM (существительные)

#### 6.2 Правила дублирования лемм
| Тип | Примеры | Количество карточек |
|-----|---------|---------------------|
| Регулярные прилагательные | petit → petite | 1 карточка: `petit, petite` |
| Инвариантные прилагательные | rouge, possible | 1 карточка: `rouge` |
| Нерегулярные прилагательные | beau/belle, vieux/vieille | 2 карточки: отдельно m и f |
| Регулярные существительные | maison, livre | 1 карточка с артиклем |
| Профессии (m/f пары) | acteur/actrice | 2 карточки: отдельно m и f |
| Глаголы | parler, aller | 1 карточка |

#### 6.3 Обязательные примечания
- Прилагательные: `+e au féminin` / `invariable` / для нерегулярных — парная форма
- Существительные: род (m/f)
- Глаголы: группа (1er/2e/3e groupe), нерегулярность
- Омографы одной категории: ссылки на другие значения
- Формы одного слова (ce/cette): ссылки на другие формы

#### 6.4 Поля, заполняемые ИИ (не скриптами)
- **ExampleFrench** — фраза-пример на французском
- **ExampleRussian** — перевод фразы
- **Notes** — примечания (нерегулярность, омографы, формы)
- **Emoji** — эмоджи для визуального запоминания
- **Russian** (Translation) — перевод слова

Скрипты генерируют только структуру карточек (French, WordType, cgram), остальное заполняется через ИИ.

#### 6.5 Правила для канадского французского (NEW)
- Если слово **не используется в Канаде** или используется иначе:
  - Указать в Notes: `⚠️ В Канаде говорят: {канадский вариант}`
  - Пример: `fin de semaine` вместо `week-end`
- Приоритет квебекского варианта при выборе примеров

#### 6.6 Тематика примеров (NEW)
По возможности использовать в ExampleFrench:
- **Юмор** — запоминается лучше
- **Канадская культура** — кленовый сироп, хоккей, зима, poutine
- **Тематика иммиграции** — документы, интеграция, работа, жильё
- **Повседневная жизнь в Квебеке** — магазины, транспорт, погода

### 7. Целевой объём
- **Фаза 1**: 3000 лемм — реалистичный набор на год изучения
- **Фаза 2**: 5000 лемм — уровень B2-C1
- Приоритет: высокочастотные слова для TEF/TCF

### 8. Озвучивание (ПЕРЕД генерацией Anki)
- Технология: Azure TTS (Cognitive Services Speech)
- Что озвучивать:
  - Французское слово
  - Французская фраза-пример
- Требования:
  - Генерация аудио вне Anki (переносимость)
  - Формат: MP3, 128 kbps
  - Именование: `{lemme}.mp3`, `{lemme}_example.mp3`
- **Голоса fr-CA** (все 4 в равной пропорции):
  - fr-CA-SylvieNeural (женский)
  - fr-CA-JeanNeural (мужской)
  - fr-CA-AntoineNeural (мужской)
  - fr-CA-ThierryNeural (мужской)
- **Технические детали**:
  - Batch обработка (3000+ файлов) — нужен rate limiting
  - Кэширование уже сгенерированных файлов
  - Обработка ошибок и повторные попытки
  - Распределение голосов: round-robin или случайное

### 9. Генерация .apkg (ПОСЛЕ озвучивания)
- Входные данные: CSV с карточками + аудиофайлы
- Упаковка аудио в media/ директорию пакета
- Ссылки на аудио: `[sound:{lemme}.mp3]`

### 10. Карточки спряжений (уже готово)
- `French_200_Verbs_Conjugation.csv`
- Отдельный note type: French Conjugation v3 Cloze

---

## Структура файлов

```
sirop-de-mots/
├── Lexique383.tsv              # Исходная база (gitignore)
├── data/
│   ├── blacklist.csv           # Слова для исключения (lemme, cgram, reason)
│   ├── whitelist_numerals.csv  # Базовые числительные для включения
│   ├── homographs_report.csv   # Отчёт об омографах (генерируется)
│   ├── professions_check.csv   # Проверка m/f профессий (генерируется)
│   ├── irregular_adjectives.csv # Нерегулярные прилагательные (генерируется)
│   └── irregular_verbs.csv     # Нерегулярные глаголы (генерируется)
├── categories/                 # Отфильтрованные категории (gitignore)
│   ├── NOM.csv
│   ├── VER.csv
│   ├── ADJ.csv
│   ├── ADV.csv
│   ├── ADJ_num.csv
│   ├── ONO.csv
│   └── other.csv
├── additions/                  # Ручные дополнения
│   ├── canadian_french.csv     # Требует исследования источников
│   └── expressions.csv         # Требует исследования источников
├── output/                     # Результаты генерации (gitignore)
│   ├── cards_skeleton.csv      # Структура карточек (French, WordType)
│   ├── cards_for_ai.csv        # Для заполнения ИИ
│   ├── cards_complete.csv      # После заполнения ИИ
│   ├── French_Vocabulary_Import.csv
│   ├── French_Conjugation_Import.csv
│   └── audio/
│       ├── words/              # {lemme}.mp3
│       └── examples/           # {lemme}_example.mp3
└── scripts/
    ├── 00_validate_input.py
    ├── 01_extract_categories.py
    ├── 02_apply_blacklist.py
    ├── 03_filter_numerals.py
    ├── 04a_find_homographs.py      # NEW
    ├── 04b_check_professions.py    # NEW
    ├── 04c_find_irregular_adj.py   # NEW
    ├── 04d_find_irregular_verbs.py # NEW
    ├── 05_merge_additions.py
    ├── 06_generate_skeleton.py     # Только структура
    ├── 07_validate_output.py
    ├── 08_generate_audio.py
    ├── 09_build_apkg.py            # NEW
    ├── config.py
    └── run_pipeline.py
```

---

## Открытые вопросы (оставшиеся)

1. **Канадские слова** — какой источник использовать? (требует исследования)
2. **Выражения** — какой объём и какие источники? (требует исследования)
3. **Точный порог частотности** — определить экспериментально для ~20000 слов

---

## Критерии готовности

- [ ] Пайплайн запускается одной командой (`python scripts/run_pipeline.py`)
- [ ] Результаты воспроизводимы (одинаковый вход → одинаковый выход)
- [ ] Blacklist легко редактировать (CSV с причиной исключения)
- [ ] Дополнения легко добавлять (единый формат CSV)
- [ ] Логи показывают статистику на каждом этапе
- [ ] Карточки проходят валидацию перед экспортом
- [ ] Аудио кэшируется (не перегенерируется повторно)

---

## Рекомендации по реализации

### Приоритет этапов
1. **Фаза 1** (Инфраструктура): Структура директорий, config.py, валидация
2. **Фаза 2** (Анализ данных): Скрипты 04a/04b/04c/04d → отчёты для ревью
3. **Фаза 3** (Blacklist): Ручной ревью редких категорий → blacklist.csv
4. **Фаза 4** (Skeleton): Генерация структуры карточек → cards_skeleton.csv
5. **Фаза 5** (ИИ): Заполнение переводов, примеров, эмоджи через Claude
6. **Фаза 6** (Озвучка): Azure TTS → audio/
7. **Фаза 7** (Финал): Сборка .apkg

### Форматы файлов

**blacklist.csv:**
```csv
lemme,cgram,reason
vingt-et-un,ADJ:num,composite_numeral
archaïsme,NOM,archaic
librairie,NOM,parse_error
```

**homographs_report.csv:**
```csv
lemme,cgram,count,meanings
son,NOM,2,"звук; отруби"
```

**cards_skeleton.csv** (генерируется скриптом):
```csv
French,WordType,cgram,freqlem,related_forms
petit,adj,ADJ,1234.5,petite
belle,adj,ADJ,987.2,beau (m)
```

**cards_for_ai.csv** (для заполнения ИИ):
```csv
French,WordType,Russian,ExampleFrench,ExampleRussian,Notes,Emoji
petit,adj,,,,,,
```

### Workflow заполнения через ИИ
1. Скрипт генерирует `cards_skeleton.csv` со структурой
2. Конвертируем в `cards_for_ai.csv` (добавляем пустые поля)
3. Batch-отправка в Claude (по 50-100 карточек)
4. Ручной ревью результатов
5. Сохранение в `cards_complete.csv`

### Следующий шаг
1. Создать структуру директорий (`data/`, `additions/`, `output/`, `scripts/`)
2. Написать `scripts/config.py` с настройками
3. Написать `scripts/04a_find_homographs.py` — оценка масштаба проблемы
4. Определить порог частотности для ~20000 слов
